<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Expense Splitter</title>
    <link rel="stylesheet" href="./styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  </head>
  <body>
    <h1>Trip Expense Splitter</h1>
    
    <!-- Add this welcome screen HTML before the dashboard-container div -->
    <div id="welcomeScreen" class="welcome-screen">
        <div class="welcome-card">
            <h1>Welcome to Trip Expense Splitter</h1>
            <div class="user-form">
                <div class="input-group">
                    <label>Your Name</label>
                    <input type="text" id="userName" placeholder="Enter your name" required>
                </div>
                <div class="input-group">
                    <label>Email Address</label>
                    <input type="email" id="userEmail" placeholder="Enter your email" required>
                </div>
            </div>
            <div class="trip-options">
                <h3>Choose an Option</h3>
                <button class="primary-button" onclick="createNewTrip()">
                    <span class="icon">‚ûï</span>
                    Create New Trip
                </button>
                <button class="secondary-button" onclick="document.getElementById('welcomeFileInput').click()">
                    <span class="icon">üìÇ</span>
                    Load Existing Trip
                </button>
                <input type="file" id="welcomeFileInput" accept=".xlsx" style="display: none;">
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="sidebar">
            <!-- Participants Section -->
            <section class="participants-container">
                <h2>Participants</h2>
                <div class="participant-add">
                    <input type="text" id="newParticipant" placeholder="Enter participant name">
                    <button onclick="addParticipant()">Add</button>
                </div>
                <div id="participants" class="participant-list"></div>
            </section>

            <!-- Import Section -->
            <section>
                <h2>Import/Export</h2>
                <div class="import-controls">
                    <input type="file" id="fileInput" accept=".xlsx" style="display: none;">
                    <button onclick="document.getElementById('fileInput').click()" class="primary-button">
                        <span class="icon">üìÇ</span> Import Excel
                    </button>
                    <button onclick="exportToExcel()" class="primary-button">
                        <span class="icon">üì§</span> Export Excel
                    </button>
                    <button onclick="confirmReset()" class="reset-button">
                        <span class="icon">üóëÔ∏è</span> Reset All Data
                    </button>
                </div>
            </section>
        </div>

        <div class="main-content">
            <!-- Expense Input Section -->
            <section>
                <h2>Add Expense <span class="info-icon" onclick="showExpenseHelp()">‚ÑπÔ∏è</span></h2>
                <div class="expense-entry">
                    <div class="input-group-container">
                        <div class="input-group">
                            <label class="tooltip">
                                Description
                                <span class="tooltiptext">Enter what this expense was for</span>
                            </label>
                            <input type="text" id="desc" placeholder="Expense description">
                        </div>
                        
                        <div class="input-group">
                            <label class="tooltip">
                                Amount
                                <span class="tooltiptext">Enter the total amount paid</span>
                            </label>
                            <input type="number" id="amount" placeholder="‚Çπ0.00">
                        </div>
                        
                        <div class="input-group">
                            <label class="tooltip">
                                Who paid
                                <span class="tooltiptext">Select who paid for this expense</span>
                            </label>
                            <select id="payer"></select>
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="tooltip">
                            Share among participants
                            <span class="tooltiptext">Select who should split this expense</span>
                        </label>
                        <div id="shareCheckboxes"></div>
                    </div>

                    <button onclick="addExpense()">Add Expense</button>
                </div>
            </section>

            <!-- Expense List & Settlement Section -->
            <section>
                <!-- Expense List Section -->
                <div id="expenseList" class="expense-list-section"></div>
                
                <!-- Settlements Container -->
                <div class="settlements-container">
                    <!-- Settlement Summary Section -->
                    <div id="settlement" class="settlement-section"></div>
                    
                    <!-- Settlement Chain Summary Section -->
                    <div id="chainSummary" class="settlement-section"></div>
                </div>
            </section>
        </div>
    </div>

    <script>
      // Single declaration of expenses array
      let expenses = [];  // Data storage for expenses

      // Add this before the localStorage functions

      // Add these functions before window.onload
      function saveToLocalStorage() {
        const data = {
            expenses: expenses,
            participants: getParticipants(),
            lastUpdated: new Date().toISOString()
        };
        localStorage.setItem('tripExpenseData', JSON.stringify(data));
      }

      function loadFromLocalStorage() {
        const savedData = localStorage.getItem('tripExpenseData');
        if (!savedData) return;

        try {
            const data = JSON.parse(savedData);
            if (!data || !Array.isArray(data.participants) || !Array.isArray(data.expenses)) {
                throw new Error('Invalid data structure');
            }

            // Restore participants
            const participantsDiv = document.getElementById("participants");
            participantsDiv.innerHTML = "";
            data.participants.forEach(name => {
                if (typeof name !== 'string') return;
                const input = document.createElement("input");
                input.type = "text";
                input.value = name;
                input.placeholder = "Name";
                participantsDiv.appendChild(input);
            });

            // Validate and restore expenses
            expenses = data.expenses.filter(exp => 
                exp && 
                typeof exp.description === 'string' &&
                typeof exp.amount === 'number' &&
                typeof exp.payer === 'string' &&
                Array.isArray(exp.beneficiaries)
            );

            // Update UI
            populateParticipants();
            renderExpenses();
            calculateSettlement();

            const lastUpdated = new Date(data.lastUpdated);
            console.log(`Data loaded from last session (${lastUpdated.toLocaleString()})`);
        } catch (error) {
            console.error('Error loading saved data:', error);
            localStorage.removeItem('tripExpenseData'); // Clear invalid data
        }
      }

      // Update the addParticipant function
      function addParticipant() {
        const newParticipantInput = document.getElementById("newParticipant");
        const name = newParticipantInput.value.trim();
        
        if (name === "") {
            alert("Please enter a participant name");
            return;
        }

        const participants = document.getElementById("participants");
        const participantDiv = document.createElement("div");
        participantDiv.className = "participant-item";
        
        // Create avatar with initials
        const avatar = document.createElement("div");
        avatar.className = "participant-avatar";
        avatar.textContent = name.split(' ').map(word => word[0].toUpperCase()).join('');
        
        const input = document.createElement("input");
        input.type = "text";
        input.value = name;
        input.placeholder = "Name";
        input.className = "participant-input";
        
        participantDiv.appendChild(avatar);
        participantDiv.appendChild(input);
        participants.appendChild(participantDiv);
        
        newParticipantInput.value = "";
        populateParticipants();
        saveToLocalStorage();
      }

      function removeLastParticipant() {
        const participants = document.getElementById("participants");
        if (participants.lastChild) {
          participants.removeChild(participants.lastChild);
          populateParticipants();
          saveToLocalStorage(); // Add this line
        }
      }

      // Add some initial participants when the page loads
      function addInitialParticipants() {
        // No initial participants - all will be added by user
        populateParticipants();
      }

      // Move the window.onload function after the localStorage functions
      window.onload = function() {
          loadFromLocalStorage();
          if (expenses.length === 0) {
              addInitialParticipants(); // Only if no saved data
          }
      };

      // Read the participant names (you could also add functionality to edit these on the fly)
      function getParticipants() {
        const inputs = document.querySelectorAll("#participants input");
        return Array.from(inputs).map(input => input.value.trim()).filter(n => n !== "");
      }

      // Populate Select and Checkbox options on page load
      function populateParticipants() {
        const participants = getParticipants();
        const payerSelect = document.getElementById("payer");
        // Clear existing options
        payerSelect.innerHTML = "";
        participants.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          payerSelect.appendChild(opt);
        });

        // Create checkboxes for the expense sharing
        const cbContainer = document.getElementById("shareCheckboxes");
        cbContainer.innerHTML = "";
        participants.forEach(name => {
          const label = document.createElement("label");
          label.style.marginRight = "10px";
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = name;
          checkbox.checked = true;
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(" " + name));
          cbContainer.appendChild(label);
        });
      }

      populateParticipants(); // initial population

      // Adds an expense from UI fields to our data model
      function addExpense() {
        const desc = document.getElementById("desc").value.trim();
        const amount = parseFloat(document.getElementById("amount").value);
        const payer = document.getElementById("payer").value;
        const cbNodes = document.querySelectorAll("#shareCheckboxes input[type=checkbox]");
        const beneficiaries = [];
        cbNodes.forEach(cb => {
          if (cb.checked) {
            beneficiaries.push(cb.value);
          }
        });

        if (!desc || !amount || isNaN(amount) || beneficiaries.length === 0) {
          alert("Please fill in all the details correctly.");
          return;
        }

        expenses.push({ description: desc, amount: amount, payer: payer, beneficiaries: beneficiaries });
        
        // Clear the expense fields
        document.getElementById("desc").value = "";
        document.getElementById("amount").value = "";
        
        renderExpenses();
        calculateSettlement();
        saveToLocalStorage(); // Add this line
      }

      // Add this after the addExpense() function
      function removeLastExpense() {
        if (expenses.length === 0) {
          alert("No expenses to remove");
          return;
        }
        
        const removedExpense = expenses.pop();
        alert(`Removed expense: ${removedExpense.description} - Amount: ${removedExpense.amount}`);
        
        // Update the display
        renderExpenses();
        calculateSettlement();
      }

      // Replace the renderExpenses() function with:
      function renderExpenses() {
        const expenseListDiv = document.getElementById("expenseList");
        expenseListDiv.innerHTML = `
            <h3>
                Expense List
                <span class="expense-count">(${expenses.length} items)</span>
            </h3>
            <div class="expense-table-container">
                <table class="expense-table">
                    <thead>
                        <tr>
                            <th>Include</th>
                            <th>#</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Paid By</th>
                            <th>Split Between</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${expenses.length === 0 ? `
                            <tr>
                                <td colspan="6" class="empty-message">No expenses added yet</td>
                            </tr>
                        ` : 
                        expenses.map((exp, index) => `
                            <tr class="expense-row ${exp.isIncluded === false ? 'excluded' : ''}">
                                <td>
                                    <input type="checkbox" 
                                        class="expense-checkbox" 
                                        data-index="${index}"
                                        ${exp.isIncluded !== false ? 'checked' : ''}
                                        onchange="toggleExpense(${index}, this.checked)">
                                </td>
                                <td>${index + 1}</td>
                                <td>${exp.description}</td>
                                <td class="amount">‚Çπ${exp.amount.toFixed(2)}</td>
                                <td>${exp.payer}</td>
                                <td>
                                    <div class="beneficiary-list">
                                        ${exp.beneficiaries.map(b => 
                                            `<span class="beneficiary-tag">${b}</span>`
                                        ).join('')}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
      }

      // Add this function to handle expense toggling
      function toggleExpense(index, included) {
        expenses[index].isIncluded = included;
        
        // Clear existing settlements before recalculating
        document.getElementById('settlement').innerHTML = '';
        document.getElementById('chainSummary').innerHTML = '';
        
        calculateSettlement();
      }

      // Calculate net settlement amounts for each participant
      function calculateSettlement() {
        // Clear existing settlement sections first
        document.getElementById('settlement').innerHTML = '';
        document.getElementById('chainSummary').innerHTML = ''; 

        const settlementDiv = document.getElementById("settlement");
        settlementDiv.innerHTML = `
            <div class="section-header">Settlement Summary</div>
        `;
        const participants = getParticipants();
        let balance = {};
        let expenditure = {};  // Track individual expenditures
        let totalExpense = 0;  // Track total trip expense
        
        // Initialize balances and expenditures
        participants.forEach(name => {
            balance[name] = 0;
            expenditure[name] = 0;
        });

        // Calculate net balances and track expenditures
        expenses.forEach(exp => {
            if (exp.isIncluded === false) return;
            
            // Add to total trip expense
            totalExpense += parseFloat(exp.amount);
            
            // Track individual expenditure
            expenditure[exp.payer] = parseFloat((expenditure[exp.payer] + exp.amount).toFixed(2));
            
            const share = parseFloat((exp.amount / exp.beneficiaries.length).toFixed(2));
            exp.beneficiaries.forEach(name => {
                balance[name] = parseFloat((balance[name] - share).toFixed(2));
            });
            balance[exp.payer] = parseFloat((balance[exp.payer] + exp.amount).toFixed(2));
        });

        // Add total trip expense
        const totalDiv = document.createElement("div");
        totalDiv.innerHTML = `<strong>Total Trip Expense: ‚Çπ${totalExpense.toFixed(2)}</strong>`;
        totalDiv.style.marginBottom = "20px";
        totalDiv.style.fontSize = "1.2em";
        totalDiv.style.color = "#1a73e8";
        settlementDiv.appendChild(totalDiv);
        
        // Create expenditure and balance table
        const balanceTable = document.createElement("table");
        balanceTable.innerHTML = `
            <tr>
                <th>Participant</th>
                <th>Total Paid</th>
                <th>Net Balance</th>
            </tr>
        `;
        
        participants.forEach(name => {
            const tr = document.createElement("tr");
            
            // Name column
            const tdName = document.createElement("td");
            tdName.textContent = name;
            
            // Expenditure column
            const tdExpenditure = document.createElement("td");
            tdExpenditure.textContent = `‚Çπ${expenditure[name].toFixed(2)}`;
            tdExpenditure.style.color = expenditure[name] > 0 ? "#34a853" : "#666";
            
            // Balance column
            const tdBalance = document.createElement("td");
            tdBalance.textContent = `‚Çπ${balance[name].toFixed(2)}`;
            tdBalance.style.color = balance[name] > 0 ? "#34a853" : "#ea4335";
            
            tr.appendChild(tdName);
            tr.appendChild(tdExpenditure);
            tr.appendChild(tdBalance);
            balanceTable.appendChild(tr);
        });
        
        settlementDiv.appendChild(balanceTable);

        // Create a container for the pie chart
        const chartContainer = document.createElement('div');
        chartContainer.style.marginTop = '30px';
        chartContainer.innerHTML = `
            <h3>Final Expense Distribution</h3>
            <div style="position: relative; height: 300px; width: 100%; max-width: 800px; margin: 0 auto;">
                <canvas id="expenseChart"></canvas>
            </div>
        `;
        settlementDiv.appendChild(chartContainer);

        // Calculate final expenses after settlements
        const finalExpenses = {};
        participants.forEach(name => {
            // Start with what they paid
            finalExpenses[name] = expenditure[name];
            
            // Add what they'll receive (positive balance)
            if (balance[name] > 0) {
                finalExpenses[name] = parseFloat((finalExpenses[name]).toFixed(2));
            }
            // Subtract what they'll pay (negative balance)
            if (balance[name] < 0) {
                finalExpenses[name] = parseFloat((finalExpenses[name] + balance[name]).toFixed(2));
            }
        });

        // Calculate total consumed expenses for each participant
        const consumedExpenses = {};
        participants.forEach(name => {
            consumedExpenses[name] = 0;
        });

        // Calculate what each person consumed
        expenses.forEach(exp => {
            if (exp.isIncluded === false) return;
            const share = exp.amount / exp.beneficiaries.length;
            exp.beneficiaries.forEach(name => {
                consumedExpenses[name] = parseFloat((consumedExpenses[name] + share).toFixed(2));
            });
        });

        // Create the column chart
        const ctx = document.getElementById('expenseChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(consumedExpenses),
                datasets: [
                    {
                        label: 'Consumed Amount',
                        data: Object.values(consumedExpenses),
                        backgroundColor: '#60a5fa',
                        borderColor: '#2563eb',
                        borderWidth: 1
                    },
                    {
                        label: 'Paid Amount',
                        data: Object.keys(consumedExpenses).map(name => expenditure[name]),
                        backgroundColor: '#34d399',
                        borderColor: '#059669',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Expense Distribution (Consumed vs Paid)',
                        font: {
                            size: 14
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y || 0;
                                const total = context.dataset.label === 'Consumed Amount' ? totalExpense : 
                                    Object.values(expenditure).reduce((sum, val) => sum + val, 0);
                                const percentage = ((value/total) * 100).toFixed(1);
                                return `${label}: ‚Çπ${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 11
                            }
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '‚Çπ' + value.toFixed(0);
                            },
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });

        // Add CSS for the chart container
        const chartStyle = document.createElement('style');
        chartStyle.textContent = `
            #expenseChart {
                background: white;
                border-radius: 8px;
                padding: 10px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
        `;
        document.head.appendChild(chartStyle);

        // Rest of the settlement code remains the same...

        // Create settlement chain summary
        const chainSummaryDiv = document.createElement("div");
        chainSummaryDiv.className = 'settlement-chain-summary';
        chainSummaryDiv.innerHTML = `
            <div class="section-header">Settlement Chain Summary</div>
            <div class="transactions-section">
                <h4>All Participant Transactions</h4>
                <div class="chain-transactions-grid">
                    ${participants.map(participantName => {
                        const participantTransactions = calculateParticipantTransactions(participantName);
                        if (Object.keys(participantTransactions).length === 0) return '';
                        
                        const netBalance = Object.values(participantTransactions)
                            .reduce((sum, amount) => sum - amount, 0);
                        const balanceClass = netBalance > 0 ? 'positive-balance' : 
                            (netBalance < 0 ? 'negative-balance' : 'neutral-balance');
                        
                        return `
                            <div class="chain-group">
                                <div class="chain-header">
                                    <h5>${participantName}</h5>
                                    <span class="net-balance ${balanceClass}">
                                        ‚Çπ${netBalance.toFixed(2)}
                                    </span>
                                </div>
                                <div class="chain-transactions">
                                    ${Object.entries(participantTransactions)
                                        .map(([otherPerson, amount]) => {
                                            const isPositive = amount < 0;
                                            return `<div class="chain-transaction ${isPositive ? 'receives-money' : 'owes-money'}">
                                                ${isPositive 
                                                    ? `‚Üê${otherPerson}: ‚Çπ${Math.abs(amount).toFixed(2)}`
                                                    : `‚Üí${otherPerson}: ‚Çπ${Math.abs(amount).toFixed(2)}`}
                                            </div>`;
                                        }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;

        // Add updated CSS for the new layout
        const chainStyle = document.createElement('style');
        chainStyle.textContent = `
            .transactions-section {
                background: white;
                border-radius: 12px;
                padding: 20px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .chain-group {
                background: #f8fafc;
                border-radius: 8px;
                margin: 15px 0;
                padding: 20px;
                border: 1px solid var(--border-color);
            }

            .chain-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid var(--border-color);
            }

            .chain-header h5 {
                color: var(--text-primary);
                margin: 0;
                font-size: 1.1em;
            }

            .net-balance {
                font-weight: 600;
                padding: 4px 12px;
                border-radius: 16px;
            }

            .positive-balance {
                background: #ecfdf5;
                color: var(--secondary-color);
            }

            .negative-balance {
                background: #fef2f2;
                color: var(--danger-color);
            }

            .neutral-balance {
                background: #f3f4f6;
                color: var(--text-secondary);
            }

            .chain-transactions {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .chain-transaction {
                padding: 10px 15px;
                border-radius: 6px;
                font-size: 0.95em;
            }

            .owes-money {
                background: #fff1f2;
                color: var(--danger-color);
                border: 1px solid #fecdd3;
            }

            .receives-money {
                background: #ecfdf5;
                color: var(--secondary-color);
                border: 1px solid #a7f3d0;
            }

            /* Update the settlements container layout */
            .settlements-container {
                display: grid;
                grid-template-columns: 1fr;  /* Changed to single column */
                gap: var(--space-md);
                margin-top: 10px;
            }

            /* Update settlement section styles */
            .settlement-section {
                background: var(--card-background);
                border-radius: 8px;
                padding: 12px;
                box-shadow: var(--shadow-sm);
            }

            /* Update section headers */
            .section-header {
                font-size: 1em;
                margin-bottom: 8px;
                padding-bottom: 6px;
                border-bottom: 1px solid var(--border-color);
            }

            /* Update settlement table styles */
            .settlement-table {
                font-size: 0.9em;
                margin-top: 10px;
            }

            .settlement-table th,
            .settlement-table td {
                padding: 8px;
            }

            /* Update transactions section layout */
            .transactions-section {
                padding: 12px;
            }

            .transactions-section h4 {
                font-size: 0.9em;
                margin-bottom: 10px;
            }

            /* New styles for the chain transactions grid */
            .chain-transactions-grid {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
                overflow-x: auto;
            }

            .chain-group {
                background: #f8fafc;
                border-radius: 6px;
                padding: 10px;
                margin: 5px 0;
                font-size: 0.85em;
            }

            .chain-header {
                margin-bottom: 8px;
                padding-bottom: 4px;
            }

            .chain-header h5 {
                font-size: 0.9em;
            }

            .chain-transaction {
                padding: 6px 8px;
                font-size: 0.8em;
            }

            .net-balance {
                padding: 2px 8px;
                font-size: 0.8em;
            }
        `;
        document.head.appendChild(chainStyle);

        // Insert the chain summary before the chart container
        settlementDiv.insertBefore(chainSummaryDiv, chartContainer);

        // Add optimized transactions section
        const optimizedTransactions = calculateOptimizedTransactions(participants, balance);
        const optimizedSection = document.createElement('div');
        optimizedSection.className = 'optimized-transactions';
        optimizedSection.innerHTML = `
            <div class="section-header">Optimized Settlement Plan</div>
            <div class="optimized-content">
                <div class="optimization-info">
                    <span class="info-badge">
                        <span class="info-icon">üí°</span>
                        Reduced from ${Object.keys(balance).length - 1} potential transactions to ${optimizedTransactions.length} transactions
                    </span>
                </div>
                <div class="optimized-list">
                    ${optimizedTransactions.map(trans => `
                        <div class="optimized-transaction">
                            <div class="transaction-path">
                                <span class="from-user">${trans.from}</span>
                                <span class="arrow">‚Üí</span>
                                <span class="to-user">${trans.to}</span>
                            </div>
                            <span class="transaction-amount">‚Çπ${trans.amount.toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        // Add CSS for optimized transactions
        const optimizedStyle = document.createElement('style');
        optimizedStyle.textContent = `
            .optimized-transactions {
                margin-top: 16px;
                background: white;
                border-radius: 8px;
                padding: 12px;
                box-shadow: var(--shadow-sm);
            }

            .optimization-info {
                margin: 8px 0 16px;
                text-align: center;
            }

            .info-badge {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 6px 12px;
                background: #f0f9ff;
                border-radius: 16px;
                font-size: 0.85em;
                color: var(--primary-color);
                border: 1px solid #bae6fd;
            }

            .info-icon {
                font-size: 1.1em;
            }

            .optimized-list {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .optimized-transaction {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 12px;
                background: #f8fafc;
                border-radius: 6px;
                font-size: 0.85em;
                border: 1px solid var(--border-color);
            }

            .transaction-path {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .from-user {
                color: var(--danger-color);
                font-weight: 500;
            }

            .to-user {
                color: var(--secondary-color);
                font-weight: 500;
            }

            .arrow {
                color: var(--text-secondary);
            }

            .transaction-amount {
                font-family: monospace;
                font-weight: 500;
                color: var(--primary-color);
            }
        `;

        document.head.appendChild(optimizedStyle);

        // Insert the optimized section after the chain summary
        document.getElementById('chainSummary').appendChild(optimizedSection);
      }

      // Add these helper functions
      function groupPaymentsByPayer(expenses, debtorName) {
        const groups = {};
        expenses
            .filter(exp => exp.beneficiaries.includes(debtorName) && exp.payer !== debtorName)
            .forEach(exp => {
                if (!groups[exp.payer]) {
                    groups[exp.payer] = [];
                }
                groups[exp.payer].push(exp);
            });
        return groups;
      }

      function calculateSubtotal(expenses, debtorName) {
        return expenses.reduce((sum, exp) => 
            sum + (exp.amount / exp.beneficiaries.length), 0);
      }

      function generateSettlementChain(expenses, debtorName) {
        const paymentsByPayer = groupPaymentsByPayer(expenses, debtorName);
        return Object.entries(paymentsByPayer)
            .map(([payer, exps]) => 
                `<li>${debtorName} -> ${payer} (‚Çπ${calculateSubtotal(exps, debtorName).toFixed(2)})</li>`
            ).join('');
      }

      // Add this before calculateSettlement function
      function generateColors(count) {
        const colors = [];
        for (let i = 0; i < count; i++) {
            const hue = (i * 137.508) % 360; // Use golden angle approximation
            const saturation = 70;
            const lightness = 60;
            colors.push(`hsl(${hue}, ${saturation}%, ${lightness}%)`);
        }
        return colors;
      }

      // Update the Excel export function to include payment instructions
      function exportToExcel() {
        try {
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // 1. Expense List Sheet
            const expenseData = expenses
                .filter(exp => exp.isIncluded !== false)
                .map((exp, idx) => ({
                    'S.No.': idx + 1,
                    'Description': exp.description,
                    'Amount': exp.amount,
                    'Paid By': exp.payer,
                    'Beneficiaries': exp.beneficiaries.join(", ")
                }));
            const wsExpenses = XLSX.utils.json_to_sheet(expenseData);
            XLSX.utils.book_append_sheet(wb, wsExpenses, "Expense List");

            // 2. Settlement Summary Sheet
            const participants = getParticipants();
            const { balance, expenditure } = calculateSettlementData();
            const settlementData = participants.map(name => ({
                'Participant': name,
                'Total Paid': expenditure[name] || 0,
                'Net Balance': balance[name] || 0,
                'Status': (balance[name] || 0) > 0 ? 'To Receive' : (balance[name] || 0) < 0 ? 'To Pay' : 'Settled'
            }));
            const wsSettlement = XLSX.utils.json_to_sheet(settlementData);
            XLSX.utils.book_append_sheet(wb, wsSettlement, "Settlement Summary");

            // 3. All Transactions Sheet
            const allTransactions = [];
            participants.forEach(name => {
                const transactions = calculateParticipantTransactions(name);
                Object.entries(transactions).forEach(([otherPerson, amount]) => {
                    if (amount > 0) {
                        allTransactions.push({
                            'From': name,
                            'To': otherPerson,
                            'Amount': amount
                        });
                    }
                });
            });
            const wsTransactions = XLSX.utils.json_to_sheet(allTransactions);
            XLSX.utils.book_append_sheet(wb, wsTransactions, "All Transactions");

            // 4. Optimized Plan Sheet
            const optimizedTransactions = calculateOptimizedTransactions(participants, balance);
            const wsOptimized = XLSX.utils.json_to_sheet(optimizedTransactions);
            XLSX.utils.book_append_sheet(wb, wsOptimized, "Optimized Plan");

            // 5. Distribution Sheet
            const distributionData = participants.map(name => {
                const paid = expenditure[name] || 0;
                const consumed = calculateConsumedAmount(name);
                const percentage = (consumed / calculateTotalExpense() * 100).toFixed(2);
                return {
                    'Participant': name,
                    'Paid Amount': paid,
                    'Consumed Amount': consumed,
                    'Percentage': `${percentage}%`
                };
            });
            const wsDistribution = XLSX.utils.json_to_sheet(distributionData);
            XLSX.utils.book_append_sheet(wb, wsDistribution, "Expense Distribution");

            // Save the file
            const fileName = `TripExpenses_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
        } catch (error) {
            console.error('Error exporting to Excel:', error);
            alert('Error exporting to Excel: ' + error.message);
        }
      }

      // Helper functions needed for Excel export
      function calculateSettlementData() {
        const participants = getParticipants();
        const balance = {};
        const expenditure = {};
        
        participants.forEach(name => {
            balance[name] = 0;
            expenditure[name] = 0;
        });

        expenses.filter(exp => exp.isIncluded !== false).forEach(exp => {
            expenditure[exp.payer] = (expenditure[exp.payer] || 0) + exp.amount;
            const share = exp.amount / exp.beneficiaries.length;
            exp.beneficiaries.forEach(name => {
                balance[name] = (balance[name] || 0) - share;
            });
            balance[exp.payer] = (balance[exp.payer] || 0) + exp.amount;
        });

        return { balance, expenditure };
      }

      function calculateConsumedAmount(participantName) {
        return expenses
            .filter(exp => exp.isIncluded !== false && exp.beneficiaries.includes(participantName))
            .reduce((sum, exp) => sum + (exp.amount / exp.beneficiaries.length), 0);
      }

      function calculateTotalExpense() {
        return expenses
            .filter(exp => exp.isIncluded !== false)
            .reduce((sum, exp) => sum + exp.amount, 0);
      }

      // Add this after the exportToExcel function
      document.getElementById('fileInput').addEventListener('change', async function(e) {
        try {
            // Clear the file input first to allow re-uploading same file
            const fileInput = e.target;
            const file = fileInput.files[0];
            fileInput.value = '';

            if (!file) {
                throw new Error('No file selected');
            }

            // Check file extension
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                throw new Error('Please select a valid Excel file (.xlsx or .xls)');
            }

            const reader = new FileReader();
            
            reader.onload = async function(event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellDates: true,
                        dateNF: 'yyyy-mm-dd'
                    });

                    // Get the first worksheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        header: 1,
                        raw: true,
                        defval: '',
                        blankrows: false
                    });

                    if (!jsonData || jsonData.length < 2) {
                        throw new Error('No valid data found in the file');
                    }

                    await importData(jsonData);
                } catch (error) {
                    console.error('Error processing Excel file:', error);
                    alert('Error processing Excel file: ' + error.message);
                }
            };

            reader.onerror = function() {
                throw new Error('Error reading file');
            };

            reader.readAsArrayBuffer(file);

        } catch (error) {
            console.error('Error handling file:', error);
            alert(error.message);
        }
      });

      function importData(jsonData) {
        try {
            if (!Array.isArray(jsonData) || jsonData.length < 2) {
                throw new Error("Invalid file format: No data found");
            }

            // Clear existing data
            expenses = [];
            const participantsSet = new Set();
            
            // First row should be headers
            const headerRow = jsonData[0];
            const expectedHeaders = ["S.No.", "Description", "Amount", "Paid By", "Beneficiaries"];
            
            // Validate headers
            if (!headerRow || headerRow.length < expectedHeaders.length) {
                throw new Error("Invalid file format: Missing headers");
            }

            for (let i = 0; i < expectedHeaders.length; i++) {
                if (headerRow[i] !== expectedHeaders[i]) {
                    throw new Error(`Invalid header: Expected "${expectedHeaders[i]}" but found "${headerRow[i]}"`);
                }
            }

            // Process expense entries starting from row 1 (after headers)
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                
                // Stop at empty row or "Net Balances" section
                if (!row || row.length === 0 || row[0] === "Net Balances") break;

                // Parse expense data
                const expense = {
                    description: String(row[1] || '').trim(),
                    amount: parseFloat(String(row[2]).replace(/[^0-9.-]+/g, '')),
                    payer: String(row[3] || '').trim(),
                    beneficiaries: String(row[4] || '').split(",").map(b => b.trim()).filter(b => b),
                    isIncluded: true
                };

                // Validate expense entry
                if (!expense.description) {
                    console.warn(`Row ${i + 1}: Missing description`);
                    continue;
                }
                if (isNaN(expense.amount) || expense.amount <= 0) {
                    console.warn(`Row ${i + 1}: Invalid amount`);
                    continue;
                }
                if (!expense.payer) {
                    console.warn(`Row ${i + 1}: Missing payer`);
                    continue;
                }
                if (expense.beneficiaries.length === 0) {
                    console.warn(`Row ${i + 1}: No beneficiaries`);
                    continue;
                }

                expenses.push(expense);
                participantsSet.add(expense.payer);
                expense.beneficiaries.forEach(b => participantsSet.add(b));
            }

            if (expenses.length === 0) {
                throw new Error("No valid expenses found in the file");
            }

            // Update participants list
            const participantsDiv = document.getElementById("participants");
            participantsDiv.innerHTML = "";
            Array.from(participantsSet).sort().forEach(name => {
                const input = document.createElement("input");
                input.type = "text";
                input.value = name;
                input.placeholder = "Name";
                participantsDiv.appendChild(input);
            });
            
            // Update UI
            populateParticipants();
            renderExpenses();
            calculateSettlement();
            saveToLocalStorage();
            
            alert(`Successfully imported ${expenses.length} expenses with ${participantsSet.size} participants!`);
            
        } catch (error) {
            console.error("Error importing data:", error);
            alert("Error importing data: " + error.message);
        }
      }

      // Add after existing script start
      function showPopup(content) {
        const backdrop = document.createElement('div');
        backdrop.className = 'popup-backdrop';
        
        const popup = document.createElement('div');
        popup.className = 'popup';
        popup.innerHTML = `
            <span class="close-popup" onclick="closePopup(this)">&times;</span>
            ${content}
        `;
        
        document.body.appendChild(backdrop);
        document.body.appendChild(popup);
        
        backdrop.style.display = 'block';
        popup.style.display = 'block';
    }

    function closePopup(element) {
        const popup = element.parentElement;
        const backdrop = document.querySelector('.popup-backdrop');
        popup.remove();
        backdrop.remove();
    }

    function showCalculationHelp() {
        const content = `
            <h3>How Calculations Work</h3>
            <div class="calculation-breakdown">
                <h4>1. Total Expenses</h4>
                <p>Sum of all included expenses in the trip.</p>
            </div>
            <div class="calculation-breakdown">
                <h4>2. Individual Share</h4>
                <p>For each expense:<br>
                ‚Ä¢ Share = Expense Amount √∑ Number of Beneficiaries<br>
                ‚Ä¢ Each beneficiary's balance is reduced by their share<br>
                ‚Ä¢ Payer's balance is increased by the full amount</p>
            </div>
            <div class="calculation-breakdown">
                <h4>3. Final Balance</h4>
                <p>‚Ä¢ Positive balance: Person should receive money<br>
                ‚Ä¢ Negative balance: Person should pay money<br>
                ‚Ä¢ Zero balance: No payment needed</p>
        `;
        showPopup(content);
    }

    function showExpenseHelp() {
        const content = `
            <h3>How to Add Expenses</h3>
            <div class="calculation-breakdown">
                <h4>1. Enter Description</h4>
                <p>Briefly describe what the expense was for (e.g., "Dinner", "Taxi ride", etc.)</p>
            </div>
            <div class="calculation-breakdown">
                <h4>2. Enter Amount</h4>
                <p>Enter the total amount paid. Use numbers only.</p>
            </div>
            <div class="calculation-breakdown">
                <h4>3. Select Payer</h4>
                <p>Choose who paid for this expense from the dropdown list.</p>
            </div>
            <div class="calculation-breakdown">
                <h4>4. Select Beneficiaries</h4>
                <p>Check everyone who should share this expense. The amount will be split equally among selected participants.</p>
        `;
        showPopup(content);
    }

    // Add these functions after your existing script section

    function saveToLocalStorage() {
        const data = {
            expenses: expenses,
            participants: getParticipants(),
            lastUpdated: new Date().toISOString()
        };
        localStorage.setItem('tripExpenseData', JSON.stringify(data));
    }

    function loadFromLocalStorage() {
        const savedData = localStorage.getItem('tripExpenseData');
        if (!savedData) return;

        try {
            const data = JSON.parse(savedData);
            if (!data || !Array.isArray(data.participants) || !Array.isArray(data.expenses)) {
                throw new Error('Invalid data structure');
            }

            // Restore participants
            const participantsDiv = document.getElementById("participants");
            participantsDiv.innerHTML = "";
            data.participants.forEach(name => {
                if (typeof name !== 'string') return;
                const input = document.createElement("input");
                input.type = "text";
                input.value = name;
                input.placeholder = "Name";
                participantsDiv.appendChild(input);
            });

            // Validate and restore expenses
            expenses = data.expenses.filter(exp => 
                exp && 
                typeof exp.description === 'string' &&
                typeof exp.amount === 'number' &&
                typeof exp.payer === 'string' &&
                Array.isArray(exp.beneficiaries)
            );

            // Update UI
            populateParticipants();
            renderExpenses();
            calculateSettlement();

            const lastUpdated = new Date(data.lastUpdated);
            console.log(`Data loaded from last session (${lastUpdated.toLocaleString()})`);
        } catch (error) {
            console.error('Error loading saved data:', error);
            localStorage.removeItem('tripExpenseData'); // Clear invalid data
        }
    }

    // Add to your script section
    function confirmReset() {
        const content = `
            <div class="confirm-dialog">
                <h3>Reset All Data?</h3>
                <p>This will remove all participants, expenses, and calculations. This action cannot be undone.</p>
                <div class="dialog-buttons">
                    <button onclick="resetAllData()" class="reset-button">Yes, Reset Everything</button>
                    <button onclick="closePopup(this.closest('.popup').querySelector('.close-popup'))" class="cancel-button">Cancel</button>
                </div>
            </div>
        `;
        showPopup(content);
    }

    // Update the resetAllData function
    function resetAllData() {
        // Clear all data
        expenses = [];
        const participantsDiv = document.getElementById("participants");
        participantsDiv.innerHTML = "";
        
        // Clear input fields
        document.getElementById("newParticipant").value = "";
        document.getElementById("desc").value = "";
        document.getElementById("amount").value = "";
        
        // Clear storage
        localStorage.removeItem('tripExpenseData');
        
        // Clear settlement sections
        document.getElementById('settlement').innerHTML = '';
        document.getElementById('chainSummary').innerHTML = '';
        
        // Update UI
        populateParticipants();
        renderExpenses();
        
        // Close the confirmation popup
        closePopup(document.querySelector('.popup .close-popup'));
        
        // Show success message
        alert("All data has been reset successfully!");
    }

    // Remove duplicate event listeners and keep only one
    document.getElementById('fileInput').addEventListener('change', async function(e) {
        try {
            const fileInput = e.target;
            const file = fileInput.files[0];
            fileInput.value = ''; // Clear input for reuse

            if (!file) {
                throw new Error('No file selected');
            }

            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                throw new Error('Please select a valid Excel file (.xlsx or .xls)');
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellDates: true,
                        dateNF: 'yyyy-mm-dd'
                    });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        header: 1,
                        raw: true,
                        defval: ''
                    });
                    importData(jsonData);
                } catch (error) {
                    console.error('Error processing Excel file:', error);
                    alert('Error processing Excel file: ' + error.message);
                }
            };
            reader.onerror = () => {
                throw new Error('Error reading file');
            };
            reader.readAsArrayBuffer(file);
        } catch (error) {
            console.error('Error handling file:', error);
            alert(error.message);
        }
    });

    // Update the importData function
    function importData(jsonData) {
        try {
            if (!Array.isArray(jsonData) || jsonData.length < 2) {
                throw new Error('Invalid file format: No data found');
            }

            // First row should be headers
            const headerRow = jsonData[0];
            const expectedHeaders = ['S.No.', 'Description', 'Amount', 'Paid By', 'Beneficiaries'];

            // Fix header validation
            for (let i = 0; i < expectedHeaders.length; i++) {
                const header = String(headerRow[i] || '').trim();
                const expected = expectedHeaders[i];
                if (header !== expected) {
                    throw new Error(`Invalid header: Expected "${expected}" but found "${header || 'empty'}"`);
                }
            }

            // Clear existing data
            expenses = [];
            const participantsSet = new Set();

            // Process expense entries
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                
                // Skip empty rows or settlement sections
                if (!row || row.length === 0 || String(row[0]).includes('Balance')) break;

                // Parse expense data
                const expense = {
                    description: String(row[1] || '').trim(),
                    amount: typeof row[2] === 'number' ? row[2] : parseFloat(String(row[2]).replace(/[^0-9.-]+/g, '')),
                    payer: String(row[3] || '').trim(),
                    beneficiaries: String(row[4] || '').split(',').map(b => b.trim()).filter(b => b),
                    isIncluded: true
                };

                // Validate expense entry
                if (!expense.description || !expense.payer || expense.beneficiaries.length === 0 || 
                    isNaN(expense.amount) || expense.amount <= 0) {
                    console.warn(`Skipping invalid row ${i + 1}`);
                    continue;
                }

                expenses.push(expense);
                participantsSet.add(expense.payer);
                expense.beneficiaries.forEach(b => participantsSet.add(b));
            }

            if (expenses.length === 0) {
                throw new Error('No valid expenses found in the file');
            }

            // Update participants list
            updateParticipantsList(Array.from(participantsSet));
            
            // Update UI
            populateParticipants();
            renderExpenses();
            calculateSettlement();
            saveToLocalStorage();

            alert(`Successfully imported ${expenses.length} expenses with ${participantsSet.size} participants!`);

        } catch (error) {
            console.error('Error importing data:', error);
            alert('Error importing data: ' + error.message);
        }
    }

    // Add this helper function
    // Fix the updateParticipantsList function
    function updateParticipantsList(participants) {
        const participantsDiv = document.getElementById('participants');
        participantsDiv.innerHTML = '';
        
        participants.sort().forEach(name => {
            const participantDiv = document.createElement('div');
            participantDiv.className = 'participant-item';
            
            // Create avatar
            const avatar = document.createElement('div');
            avatar.className = 'participant-avatar';
            avatar.textContent = name.split(' ').map(word => word[0].toUpperCase()).join('');
            
            // Create input
            const input = document.createElement('input');
            input.type = 'text';
            input.value = name;
            input.placeholder = 'Name';
            input.className = 'participant-input';
            
            participantDiv.appendChild(avatar);
            participantDiv.appendChild(input);
            participantsDiv.appendChild(participantDiv);
        });
    }

    // Add this helper function before calculateSettlement()
    function calculateParticipantTransactions(participantName) {
        const transactions = {};
        
        expenses.forEach(exp => {
            if (exp.isIncluded === false) return;
            
            // If participant is a beneficiary but not the payer
            if (exp.beneficiaries.includes(participantName) && exp.payer !== participantName) {
                const share = exp.amount / exp.beneficiaries.length;
                if (!transactions[exp.payer]) transactions[exp.payer] = 0;
                transactions[exp.payer] += share;
            }
            
            // If participant is the payer
            if (exp.payer === participantName) {
                exp.beneficiaries.forEach(beneficiary => {
                    if (beneficiary !== participantName) {
                        const share = exp.amount / exp.beneficiaries.length;
                        if (!transactions[beneficiary]) transactions[beneficiary] = 0;
                        transactions[beneficiary] -= share;
                    }
                });
            }
        });
        
        return transactions;
    }

    // Add these variables at the start of your script
    let userData = {
        name: '',
        email: '',
        currentTrip: null
    };

    // Add these functions to handle the welcome screen
    function createNewTrip() {
        const name = document.getElementById('userName').value.trim();
        const email = document.getElementById('userEmail').value.trim();
        
        if (!validateUserInput(name, email)) return;
        
        saveUserData(name, email);
        hideWelcomeScreen();
        initializeNewTrip();
    }

    function validateUserInput(name, email) {
        if (!name) {
            alert('Please enter your name');
            return false;
        }
        if (!email || !email.includes('@')) {
            alert('Please enter a valid email address');
            return false;
        }
        return true;
    }

    function saveUserData(name, email) {
        userData.name = name;
        userData.email = email;
        localStorage.setItem('tripExpenseUserData', JSON.stringify(userData));
    }

    function hideWelcomeScreen() {
        document.getElementById('welcomeScreen').style.display = 'none';
        document.querySelector('.dashboard-container').style.display = 'grid';
    }

    function initializeNewTrip() {
        expenses = [];
        const participantsDiv = document.getElementById('participants');
        participantsDiv.innerHTML = '';
        
        // Add the current user as first participant
        addParticipant(userData.name);
        
        populateParticipants();
        renderExpenses();
        calculateSettlement();
        saveToLocalStorage();
    }

    // Modify window.onload
    window.onload = function() {
        const savedUserData = localStorage.getItem('tripExpenseUserData');
        const savedTripData = localStorage.getItem('tripExpenseData');
        
        // Ensure dashboard is hidden initially
        const dashboard = document.querySelector('.dashboard-container');
        if (dashboard) {
            dashboard.style.display = 'none';
        }
        
        // Load saved data if available
        if (savedUserData && savedTripData) {
            try {
                userData = JSON.parse(savedUserData);
                hideWelcomeScreen();
                loadFromLocalStorage();
            } catch (error) {
                console.error('Error loading saved data:', error);
                localStorage.removeItem('tripExpenseUserData');
                localStorage.removeItem('tripExpenseData');
            }
        }
        
        // Add welcome screen file input handler
        const welcomeFileInput = document.getElementById('welcomeFileInput');
        if (welcomeFileInput) {
            welcomeFileInput.addEventListener('change', function(e) {
                const name = document.getElementById('userName').value.trim();
                const email = document.getElementById('userEmail').value.trim();
                
                if (!validateUserInput(name, email)) {
                    e.target.value = '';
                    return;
                }
                
                saveUserData(name, email);
                hideWelcomeScreen();
                handleFileInput(e);
            });
        }
    };

    // Helper function to handle file input
    function handleFileInput(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.name.toLowerCase().endsWith('.xlsx')) {
            alert('Please select a valid Excel file (.xlsx)');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {
                    header: 1,
                    raw: false
                });
                importData(jsonData);
            } catch (error) {
                alert('Error reading file: ' + error.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // Add this helper function to calculate optimized transactions
    function calculateOptimizedTransactions(participants, balance) {
        // Create arrays of debtors and creditors
        let debtors = [];
        let creditors = [];
        
        participants.forEach(name => {
            const amount = parseFloat(balance[name].toFixed(2));
            if (amount < -0.01) {
                debtors.push({ name, amount: -amount });
            } else if (amount > 0.01) {
                creditors.push({ name, amount });
            }
        });

        // Sort by amount (descending)
        debtors.sort((a, b) => b.amount - a.amount);
        creditors.sort((a, b) => b.amount - a.amount);

        // Calculate optimized transactions
        let optimizedTransactions = [];
        let i = 0, j = 0;

        while (i < debtors.length && j < creditors.length) {
            const debtor = debtors[i];
            const creditor = creditors[j];
            
            const amount = Math.min(debtor.amount, creditor.amount);
            if (amount > 0) {
                optimizedTransactions.push({
                    from: debtor.name,
                    to: creditor.name,
                    amount: amount
                });
            }

            debtor.amount -= amount;
            creditor.amount -= amount;

            if (debtor.amount < 0.01) i++;
            if (creditor.amount < 0.01) j++;
        }

        return optimizedTransactions;
    }
    </script>
    
  </body>
</html>